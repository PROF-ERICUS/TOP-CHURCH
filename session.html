<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance Session - Grace Fellowship Church</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: #f8f9fa; min-height: 100vh; display: flex; flex-direction: column; }
  main { flex: 1; padding: 40px 20px 20px; max-width: 900px; margin: auto; }
  .card { margin-bottom: 20px; }
</style>
</head>
<body>

<header class="bg-primary text-white py-3 mb-3">
  <div class="container d-flex justify-content-between align-items-center">
    <h3 class="m-0">Attendance Session</h3>
    <nav>
      <a href="index.html" class="btn btn-light btn-sm mx-1">Home</a>
      <a href="registration.html" class="btn btn-light btn-sm mx-1">Register</a>
      <a href="admin-dash.html" class="btn btn-light btn-sm mx-1">Admin</a>
      <a href="session.html" class="btn btn-light btn-sm mx-1">Attendance</a>
    </nav>
  </div>
</header>

<main>
  <h2 class="text-center mb-4">ðŸ“… Attendance Session</h2>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Mark Attendance</h5>
      <input type="text" id="memberPhone" class="form-control mb-2" placeholder="Enter member phone number">
      <button id="markAttendanceBtn" class="btn btn-success w-100">Mark Attendance</button>
      <div id="attendanceMsg" class="mt-2"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">Attendance Records</h5>
      <ul id="attendanceList" class="list-group"></ul>
    </div>
  </div>
</main>

<script>
let currentSession = JSON.parse(localStorage.getItem("currentSession")) || null;
let members = JSON.parse(localStorage.getItem("members")) || [];

const markBtn = document.getElementById("markAttendanceBtn");
const phoneInput = document.getElementById("memberPhone");
const attendanceMsg = document.getElementById("attendanceMsg");
const attendanceList = document.getElementById("attendanceList");

function renderAttendanceRecords() {
  attendanceList.innerHTML = "";
  if(!currentSession || !currentSession.attendanceRecords?.length){
    attendanceList.innerHTML = "<li class='list-group-item'>No attendance yet.</li>";
    return;
  }
  currentSession.attendanceRecords.forEach(r => {
    const li = document.createElement("li");
    li.className = "list-group-item";
    li.textContent = `${r.name} (${r.phone}) - ${r.status} [${r.date} ${r.time}]`;
    attendanceList.appendChild(li);
  });
}

markBtn.onclick = () => {
  if(!currentSession || !currentSession.sessionOpen) {
    return attendanceMsg.innerHTML="<div class='text-danger'>Session is not open!</div>";
  }
  const phone = phoneInput.value.trim();
  if(!phone) return;

  const member = members.find(m => m.phone === phone);
  if(!member) return attendanceMsg.innerHTML="<div class='text-danger'>Member not found!</div>";

  if(currentSession.attendanceRecords.some(r => r.phone === phone)) {
    return attendanceMsg.innerHTML="<div class='text-warning'>Already marked!</div>";
  }

  const now = new Date();
  currentSession.attendanceRecords.push({
    name: member.fullName,
    phone: member.phone,
    status: "Present",
    date: currentSession.sessionDate,
    time: now.toTimeString().slice(0,5)
  });

  localStorage.setItem("currentSession", JSON.stringify(currentSession));
  attendanceMsg.innerHTML="<div class='text-success'>Attendance marked!</div>";
  phoneInput.value = "";
  renderAttendanceRecords();
};

// --- Initialize ---
renderAttendanceRecords();
</script>

</body>
</html>
